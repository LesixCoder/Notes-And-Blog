## é…ç½® loader

### loader åŒ¹é…è§„åˆ™

```js
module.exports = {
  // ...
  module: {
    rules: [
      {
        test: /\.jsx?/, // æ¡ä»¶
        include: [path.resolve(__dirname, 'src')], // æ¡ä»¶
        use: 'babel-loader' // è§„åˆ™åº”ç”¨ç»“æœ
      } // ä¸€ä¸ª object å³ä¸€æ¡è§„åˆ™
      // ...
    ]
  }
};
```

loader çš„åŒ¹é…è§„åˆ™ä¸­æœ‰ä¸¤ä¸ªæœ€å…³é”®çš„å› ç´ ï¼šä¸€ä¸ªæ˜¯åŒ¹é…æ¡ä»¶ï¼Œä¸€ä¸ªæ˜¯åŒ¹é…è§„åˆ™åçš„åº”ç”¨ã€‚

åŒ¹é…æ¡ä»¶é€šå¸¸éƒ½ä½¿ç”¨è¯·æ±‚èµ„æºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ¥è¿›è¡ŒåŒ¹é…ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­ç§°ä¸º `resource`ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰æ¯”è¾ƒå°‘ç”¨åˆ°çš„ `issuer`ï¼Œåˆ™æ˜¯å£°æ˜ä¾èµ–è¯·æ±‚çš„æºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚ä¸¾ä¸ªä¾‹å­ï¼šåœ¨ `/path/to/app.js` ä¸­å£°æ˜å¼•å…¥ `import './src/style.scss'`ï¼Œ`resource` æ˜¯ `/path/to/src/style.scss`ï¼Œ`issuer` æ˜¯ `/path/to/app.js`ï¼Œè§„åˆ™æ¡ä»¶ä¼šå¯¹è¿™ä¸¤ä¸ªå€¼æ¥å°è¯•åŒ¹é…ã€‚

ä¸Šè¿°ä»£ç ä¸­çš„ `test` å’Œ `include` éƒ½ç”¨äºåŒ¹é… `resource` è·¯å¾„ï¼Œæ˜¯ `resource.test` å’Œ `resource.include` çš„ç®€å†™ï¼Œä½ ä¹Ÿå¯ä»¥è¿™ä¹ˆé…ç½®ï¼š

```js
module.exports = {
  // ...
  rules: [
    {
      resource: {
        // resource çš„åŒ¹é…æ¡ä»¶
        test: /\.jsx?/,
        include: [path.resolve(__dirname, 'src')]
      },
      // å¦‚æœè¦ä½¿ç”¨ issuer åŒ¹é…ï¼Œä¾¿æ˜¯ issuer: { test: ... }
      use: 'babel-loader'
    }
    // ...
  ]
};
```

### è§„åˆ™æ¡ä»¶é…ç½®

- `{ test: ... }` åŒ¹é…ç‰¹å®šæ¡ä»¶
- `{ include: ... }` åŒ¹é…ç‰¹å®šè·¯å¾„
- `{ exclude: ... }` æ’é™¤ç‰¹å®šè·¯å¾„
- `{ and: [...] }` å¿…é¡»åŒ¹é…æ•°ç»„ä¸­æ‰€æœ‰æ¡ä»¶
- `{ or: [...] }` åŒ¹é…æ•°ç»„ä¸­ä»»æ„ä¸€ä¸ªæ¡ä»¶
- `{ not: [...] }` æ’é™¤åŒ¹é…æ•°ç»„ä¸­æ‰€æœ‰æ¡ä»¶

ä¸Šè¿°çš„æ‰€è°“æ¡ä»¶çš„å€¼å¯ä»¥æ˜¯ï¼š

- å­—ç¬¦ä¸²ï¼šå¿…é¡»ä»¥æä¾›çš„å­—ç¬¦ä¸²å¼€å§‹ï¼Œæ‰€ä»¥æ˜¯å­—ç¬¦ä¸²çš„è¯ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æä¾›ç»å¯¹è·¯å¾„
- æ­£åˆ™è¡¨è¾¾å¼ï¼šè°ƒç”¨æ­£åˆ™çš„ `test` æ–¹æ³•æ¥åˆ¤æ–­åŒ¹é…
- å‡½æ•°ï¼š`(path) => boolean`ï¼Œè¿”å› true è¡¨ç¤ºåŒ¹é…
- æ•°ç»„ï¼šè‡³å°‘åŒ…å«ä¸€ä¸ªæ¡ä»¶çš„æ•°ç»„
- å¯¹è±¡ï¼šåŒ¹é…æ‰€æœ‰å±æ€§å€¼çš„æ¡ä»¶

```js
rules: [
  {
    test: /\.jsx?/, // æ­£åˆ™
    include: [
      path.resolve(__dirname, 'src'), // å­—ç¬¦ä¸²ï¼Œæ³¨æ„æ˜¯ç»å¯¹è·¯å¾„
    ], // æ•°ç»„
    // ...
  },
  {
    test: {
      js: /\.js/,
      jsx: /\.jsx/,
    }, // å¯¹è±¡ï¼Œä¸å»ºè®®ä½¿ç”¨
    not: [
      (value) => { /* ... */ return true; }, // å‡½æ•°ï¼Œé€šå¸¸éœ€è¦é«˜åº¦è‡ªå®šä¹‰æ—¶æ‰ä¼šä½¿ç”¨
    ],
  },
],
```

## module type

webpack 4.x ç‰ˆæœ¬å¼ºåŒ–äº† `module type`ï¼Œå³æ¨¡å—ç±»å‹çš„æ¦‚å¿µï¼Œä¸åŒçš„æ¨¡å—ç±»å‹ç±»ä¼¼äºé…ç½®äº†ä¸åŒçš„ loaderï¼Œwebpack ä¼šæœ‰é’ˆå¯¹æ€§åœ°è¿›è¡Œå¤„ç†ï¼Œç°é˜¶æ®µå®ç°äº†ä»¥ä¸‹ 5 ç§æ¨¡å—ç±»å‹ã€‚

- `javascript/auto`ï¼šå³ webpack 3 é»˜è®¤çš„ç±»å‹ï¼Œæ”¯æŒç°æœ‰çš„å„ç§ JS ä»£ç æ¨¡å—ç±»å‹ â€”â€” CommonJSã€AMDã€ESM
- `javascript/esm`ï¼šECMAScript modulesï¼Œå…¶ä»–æ¨¡å—ç³»ç»Ÿï¼Œä¾‹å¦‚ CommonJS æˆ–è€… AMD ç­‰ä¸æ”¯æŒï¼Œæ˜¯ `.mjs` æ–‡ä»¶çš„é»˜è®¤ç±»å‹
- `javascript/dynamic`ï¼šCommonJS å’Œ AMDï¼Œæ’é™¤ ESM
- `javascript/json`ï¼šJSON æ ¼å¼æ•°æ®ï¼Œ`require` æˆ–è€… `import` éƒ½å¯ä»¥å¼•å…¥ï¼Œæ˜¯ `.json` æ–‡ä»¶çš„é»˜è®¤ç±»å‹
- `webassembly/experimental`ï¼šWebAssembly modulesï¼Œå½“å‰è¿˜å¤„äºè¯•éªŒé˜¶æ®µï¼Œæ˜¯ `.wasm` æ–‡ä»¶çš„é»˜è®¤ç±»å‹

å¦‚æœä¸å¸Œæœ›ä½¿ç”¨é»˜è®¤çš„ç±»å‹çš„è¯ï¼Œåœ¨ç¡®å®šå¥½åŒ¹é…è§„åˆ™æ¡ä»¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `type` å­—æ®µæ¥æŒ‡å®šæ¨¡å—ç±»å‹ï¼Œä¾‹å¦‚æŠŠæ‰€æœ‰çš„ JS ä»£ç æ–‡ä»¶éƒ½è®¾ç½®ä¸ºå¼ºåˆ¶ä½¿ç”¨ ESM ç±»å‹ï¼š

```js
{
  test: /\.js/,
  include: [
    path.resolve(__dirname, 'src'),
  ],
  type: 'javascript/esm', // è¿™é‡ŒæŒ‡å®šæ¨¡å—ç±»å‹
},
```

### ä½¿ç”¨ loader é…ç½®

```js
rules: [
  {
    test: /\.less/,
    use: [
      'style-loader', // ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²è¡¨ç¤º loader
      {
        loader: 'css-loader',
        options: {
          importLoaders: 1
        },
      }, // ç”¨å¯¹è±¡è¡¨ç¤º loaderï¼Œå¯ä»¥ä¼ é€’ loader é…ç½®ç­‰
      {
        loader: 'less-loader',
        options: {
          noIeCompat: true
        }, // ä¼ é€’ loader é…ç½®
      },
    ],
  },
],
```

`use` å­—æ®µå¯ä»¥æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…è¡¨ç¤º loader çš„å¯¹è±¡ã€‚å¦‚æœåªéœ€è¦ä¸€ä¸ª loaderï¼Œä¹Ÿå¯ä»¥è¿™æ ·ï¼š

```js
use: {
  loader: 'babel-loader',
  options: { ... }
}
```

### loader åº”ç”¨é¡ºåº

ä¸€ä¸ªåŒ¹é…è§„åˆ™ä¸­å¯ä»¥é…ç½®ä½¿ç”¨å¤šä¸ª loaderï¼Œå³ä¸€ä¸ªæ¨¡å—æ–‡ä»¶å¯ä»¥ç»è¿‡å¤šä¸ª loader çš„è½¬æ¢å¤„ç†ï¼Œæ‰§è¡Œé¡ºåºæ˜¯ä»æœ€åé…ç½®çš„ loader å¼€å§‹ï¼Œä¸€æ­¥æ­¥å¾€å‰ã€‚

å¦‚æœå¤šä¸ª `rule` åŒ¹é…äº†åŒä¸€ä¸ªæ¨¡å—æ–‡ä»¶ï¼Œloader çš„åº”ç”¨é¡ºåºåˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿçœ‹ä¸€ä»½è¿™æ ·çš„é…ç½®ï¼š

```js
rules: [
  {
    test: /\.js$/,
    exclude: /node_modules/,
    loader: "eslint-loader",
  },
  {
    test: /\.js$/,
    exclude: /node_modules/,
    loader: "babel-loader",
  },
],
```

è¿™æ ·æ— æ³•æ³•ä¿è¯ eslint-loader åœ¨ babel-loader åº”ç”¨å‰æ‰§è¡Œã€‚webpack åœ¨ `rules` ä¸­æä¾›äº†ä¸€ä¸ª `enforce` çš„å­—æ®µæ¥é…ç½®å½“å‰ rule çš„ loader ç±»å‹ï¼Œæ²¡é…ç½®çš„è¯æ˜¯æ™®é€šç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½® `pre` æˆ– `post`ï¼Œåˆ†åˆ«å¯¹åº”å‰ç½®ç±»å‹æˆ–åç½®ç±»å‹çš„ loaderã€‚

> eslint-loader è¦æ£€æŸ¥çš„æ˜¯äººå·¥ç¼–å†™çš„ä»£ç ï¼Œå¦‚æœåœ¨ babel-loader ä¹‹åä½¿ç”¨ï¼Œé‚£ä¹ˆæ£€æŸ¥çš„æ˜¯ Babel è½¬æ¢åçš„ä»£ç ï¼Œæ‰€ä»¥å¿…é¡»åœ¨ babel-loader å¤„ç†ä¹‹å‰ä½¿ç”¨ã€‚

è¿˜æœ‰ä¸€ç§è¡Œå†… loaderï¼Œå³æˆ‘ä»¬åœ¨åº”ç”¨ä»£ç ä¸­å¼•ç”¨ä¾èµ–æ—¶ç›´æ¥å£°æ˜ä½¿ç”¨çš„ loaderï¼Œå¦‚ `const json = require('json-loader!./file.json')` è¿™ç§ã€‚ä¸å»ºè®®åœ¨åº”ç”¨å¼€å‘ä¸­ä½¿ç”¨è¿™ç§ loaderï¼Œåç»­æˆ‘ä»¬è¿˜ä¼šå†æåˆ°ã€‚

é¡¾åæ€ä¹‰ï¼Œæ‰€æœ‰çš„ loader æŒ‰ç…§ `å‰ç½® -> è¡Œå†… -> æ™®é€š -> åç½®` çš„é¡ºåºæ‰§è¡Œã€‚æ‰€ä»¥å½“æˆ‘ä»¬è¦ç¡®ä¿ eslint-loader åœ¨ babel-loader ä¹‹å‰æ‰§è¡Œæ—¶ï¼Œå¯ä»¥å¦‚ä¸‹æ·»åŠ  `enforce` é…ç½®ï¼š

```js
rules: [
  {
    enforce: 'pre', // æŒ‡å®šä¸ºå‰ç½®ç±»å‹
    test: /\.js$/,
    exclude: /node_modules/,
    loader: "eslint-loader",
  },
]
```

### ä½¿ç”¨ `noParse`

é™¤äº† `module.rules` å­—æ®µç”¨äºé…ç½® loader ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª `module.noParse` å­—æ®µï¼Œå¯ä»¥ç”¨äºé…ç½®å“ªäº›æ¨¡å—æ–‡ä»¶çš„å†…å®¹ä¸éœ€è¦è¿›è¡Œè§£æã€‚å¯¹äºä¸€äº›ä¸éœ€è¦è§£æä¾èµ–ï¼ˆå³æ— ä¾èµ–ï¼‰ çš„ç¬¬ä¸‰æ–¹å¤§å‹ç±»åº“ç­‰ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªå­—æ®µæ¥é…ç½®ï¼Œä»¥æé«˜æ•´ä½“çš„æ„å»ºé€Ÿåº¦ã€‚

> ä½¿ç”¨ `noParse` è¿›è¡Œå¿½ç•¥çš„æ¨¡å—æ–‡ä»¶ä¸­ä¸èƒ½ä½¿ç”¨ `import`ã€`require`ã€`define` ç­‰å¯¼å…¥æœºåˆ¶ã€‚

```js
module.exports = {
  // ...
  module: {
    noParse: /jquery|lodash/, // æ­£åˆ™è¡¨è¾¾å¼

    // æˆ–è€…ä½¿ç”¨ function
    noParse(content) {
      return /jquery|lodash/.test(content)
    },
  }
}
```

ä¸Šä¸€èŠ‚ï¼š[webpackåŸºæœ¬é…ç½®ä»‹ç»](https://github.com/lsxlsxxslxsl/Read-Books-Notes/blob/master/post/webpck4%E5%88%9D%E4%BD%93%E9%AA%8C/01.webpack%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E4%BB%8B%E7%BB%8D.md)
ä¸‹ä¸€èŠ‚ï¼š[é…ç½®plugin](https://github.com/lsxlsxxslxsl/Read-Books-Notes/blob/master/post/webpck4%E5%88%9D%E4%BD%93%E9%AA%8C/03.%E9%85%8D%E7%BD%AEplugin.md)